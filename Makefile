# Define the compiler and compiler flags
CXX = g++
OPT_CXXFLAGS = -O0 -g # TODO: Change to -O3 for release
CXXFLAGS = -std=c++14 -Wall -Wextra -pedantic $(OPT_CXXFLAGS)

# Define the source files and header files
SRC_ENCODER = rds_encoder.cpp
SRC_DECODER = rds_decoder.cpp
HEADERS = rds_encoder.hpp rds_decoder.hpp shared.hpp

# Define the output binaries
BIN_ENCODER = rds_encoder
BIN_DECODER = rds_decoder

XLOGIN = xlapes02

# Default target
all: $(BIN_ENCODER) $(BIN_DECODER)

# Build encoder
$(BIN_ENCODER): $(SRC_ENCODER) $(HEADERS)
	$(CXX) $(CXXFLAGS) -o $(BIN_ENCODER) $(SRC_ENCODER)

# Build decoder
$(BIN_DECODER): $(SRC_DECODER) $(HEADERS)
	$(CXX) $(CXXFLAGS) -o $(BIN_DECODER) $(SRC_DECODER)

# Clean the build
clean:
	rm -f $(BIN_ENCODER) $(BIN_DECODER)

clean-all:
	rm -f $(BIN_ENCODER) $(BIN_DECODER)
	rm -f $(XLOGIN).pdf $(XLOGIN).zip

valgrind-encoder: $(BIN_ENCODER)
	valgrind --leak-check=yes ./$(BIN_ENCODER) -g 0A -pi 4660 -pty 5 -tp 1 -ms 0 -ta 1 -af 104.5,98.0 -ps "RadioXYZ"

valgrind-decoder: $(BIN_DECODER)
	valgrind --leak-check=yes ./$(BIN_DECODER)

run-encoder-0a: $(BIN_ENCODER)
	./$(BIN_ENCODER) -g 0A -pi 4660 -pty 5 -tp 1 -ms 0 -ta 1 -af 104.5,98.0 -ps "RadioXYZ"

run-encoder-2a: $(BIN_ENCODER)
	./$(BIN_ENCODER) -g 2A -pi 4660 -pty 5 -tp 1 -rt "Now Playing: Song Title by Artist" -ab 0

run-decoder-0a: $(BIN_DECODER)
	./$(BIN_DECODER) -b 00010010001101000001101010000001001011000011111111101010101001101001000001101101010010011000011010101001000100100011010000011010100000010010110001100100011100000000000000000101101000011001000110100111110001100001001000110100000110101000000100101100100010001100000000000000000001011010000110111101011000010011101000010010001101000001101010000001001011001101001101010000000000000000010110100001011001010110100000100100

run-decoder-2a: $(BIN_DECODER)
	./$(BIN_DECODER) -b 00010010001101000001101010001001001010000011111011100100111001101111100111101101110111001000001100100100000100100011010000011010100010010010100001100101011101010000011011001000101010011000010111100111110101010001001000110100000110101000100100101000100010011100011010010110111010011110010110011100111010111110000100010010001101000001101010001001001010001101001001010010000001010011111000010001101111011011100001101101000100100011010000011010100010010010100100001011001101100111001000000011110011010101000110100111011000100001001000110100000110101000100100101001010100001010011101000110110010111101010110010100100000011001011100010010001101000001101010001001001010011011110000010110001001111001100110110100100000010000011110010101000100100011010000011010100010010010100111100111100001110010011101000010000001011010010111001100111111010001001000110100000110101000100100101010000011101101011101000010000010100111000010000000100000001101110000010010001101000001101010001001001010100101010101000010000000100000000000000000100000001000000011011100000100100011010000011010100010010010101010111001111100100000001000000000000000001000000010000000110111000001001000110100000110101000100100101010111000100110001000000010000000000000000010000000100000001101110000010010001101000001101010001001001010110011101100000010000000100000000000000000100000001000000011011100000100100011010000011010100010010010101101100000100100100000001000000000000000001000000010000000110111000001001000110100000110101000100100101011100011000010001000000010000000000000000010000000100000001101110000010010001101000001101010001001001010111101011110110010000000100000000000000000100000001000000011011100

build:
	docker compose build

run-docker:
	docker compose run --remove-orphans --entrypoint /usr/bin/fish app

down-docker:
	docker compose down

pack:
	pandoc $(XLOGIN).md  -o $(XLOGIN).pdf
	zip -r $(XLOGIN).zip Makefile *.cpp *.hpp $(XLOGIN).pdf
	./check_zip.sh $(XLOGIN).zip

# Phony targets
.PHONY: all clean valgrind-encoder valgrind-decoder run-docker down-docker
